
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transparent Symbolic Execution of Function Calls &#8212; Symbolic Execution: Foundations, Techniques, Applications and Future Perspectives</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/page.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Loops in Static Symbolic Execution" href="static_loops.html" />
    <link rel="prev" title="Techniques" href="techniques.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Symbolic Execution: Foundations, Techniques, Applications and Future Perspectives</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="minipy.html">
   Parser and Interpreter for minipy
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="foundations.html">
   Foundations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="constraint_solving.html">
     Constraint Solving
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="semantics.html">
     Syntax and Semantics of Symbolic States
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="symbolic_interpreter.html">
     A Symbolic Interpreter and Correctness of Symbolic Transitions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="correctness.html">
     Correctness of Symbolic Transitions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="techniques.html">
   Techniques
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Transparent Symbolic Execution of Function Calls
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="static_loops.html">
     Loops in Static Symbolic Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="compositional.html">
     Compositional Symbolic Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="concolic.html">
     Concolic Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="stateexplosion.html">
     Tackling State Explosion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="selective.html">
     Selective Symbolic Execution
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="applications.html">
   Applications
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="proving.html">
     Program Proving
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="fuzzing.html">
     Symbolic Fuzzing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="debugging.html">
     Symbolic Debugging
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="perspectives.html">
   Future Perspectives
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="conclusion.html">
   Conclusion
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/transparent_function_execution.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rindPHI/se-book-festschrift-rh"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rindPHI/se-book-festschrift-rh/issues/new?title=Issue%20on%20page%20%2Ftransparent_function_execution.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parsing-method-frames-and-transforming-function-calls">
   Parsing Method Frames and Transforming Function Calls
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#semantics-and-symbolic-execution-of-method-frames">
   Semantics and Symbolic Execution of Method Frames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="transparent-symbolic-execution-of-function-calls">
<span id="techniques-transparent-function-execution"></span><h1>Transparent Symbolic Execution of Function Calls<a class="headerlink" href="#transparent-symbolic-execution-of-function-calls" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">minipy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">constraint_solving</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">semantics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">symbolic_interpreter</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</div>
<p>Sometimes, one is not only concerned about the final outcome of a symbolic execution, but additionally intends to explore intermediate states leading to these results. An example application where this is the case is <em>symbolic debugging</em> (see <a class="reference internal" href="debugging.html#applications-symbolic-debugging"><span class="std std-ref">Symbolic Debugging</span></a>): If an execution result is not as expected, inspecting intermediate states can help locating and ultimately fixing the issue. Our symbolic interpreter defined in <a class="reference internal" href="symbolic_interpreter.html#foundations-symbolic-interpreter"><span class="std std-ref">A Symbolic Interpreter and Correctness of Symbolic Transitions</span></a> has a flaw in this regard. Consider again the execution of our linear search program:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">search_program</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">def find(needle: int, haystack: tuple) -&gt; int:</span>
<span class="s2">    i = 0</span>
<span class="s2">    while i &lt; len(haystack):</span>
<span class="s2">        if haystack[i] == needle:</span>
<span class="s2">            break</span>
<span class="s2">            </span>
<span class="s2">        i = i + 1</span>
<span class="s2">    else:</span>
<span class="s2">        return -1</span>
<span class="s2">    </span>
<span class="s2">    return i</span>

<span class="s2">t = (1, 2, 3, 4, )</span>
<span class="s2">r = find(x, t)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display_program</span><span class="p">(</span><span class="n">search_program</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">needle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">haystack</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">haystack</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">haystack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">needle</span><span class="p">:</span>
            <span class="k">break</span>
            
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">i</span>

<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll tag_full-width docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">INT_TYPE</span><span class="p">)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">SymbolicEnvironment</span><span class="p">(</span><span class="n">SymbolicStore</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_z3</span><span class="p">()}))</span>
<span class="n">predicates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">z3</span><span class="o">.</span><span class="n">SeqSort</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">IntSort</span><span class="p">()),),</span> <span class="n">z3</span><span class="o">.</span><span class="n">IntSort</span><span class="p">(),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Length</span><span class="p">)}</span>
<span class="n">interpreter</span> <span class="o">=</span> <span class="n">SymbolicInterpreter</span><span class="p">(</span><span class="n">predicates</span><span class="o">=</span><span class="n">predicates</span><span class="p">)</span>

<span class="n">search_program_ast</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">search_program</span><span class="p">)</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">search_program_ast</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
<span class="n">display_set</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/transparent_function_execution_4_0.svg" src="_images/transparent_function_execution_4_0.svg" /></div>
</div>
<p>Inspecting the execution tree for the function is not much more useful than examining the leaves only, since the tree proceeds from the assignment with the function call to the results of the call <em>in a single step</em>. If there was a bug within the <code class="docutils literal notranslate"><span class="pre">find</span></code> method, this SET does not help locating it.</p>
<p>An alternative to our previous design choice of processing a function definition by storing a continuation returning an evaluation result is to <em>replace</em> a function call by the function’s body. We call this process <em>inlining</em>. This approach ensures transparency in the sense that the function body appears in the final SET, but requires some program transformation inside the body. In the case of the minipy language, it suffices to transform <code class="docutils literal notranslate"><span class="pre">return</span></code> statements to assignments. For example, we replace the statement <code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">=</span> <span class="pre">find(x,</span> <span class="pre">t)</span></code> above with the body of <code class="docutils literal notranslate"><span class="pre">find</span></code>, such that (1) function parameters in the body are instantiated correctly and (2) all <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">expr</span></code> statements are replaced by <code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">=</span> <span class="pre">expr</span></code>. For an object-oriented language, we additionally have to instantiate <code class="docutils literal notranslate"><span class="pre">self</span></code> calls to the containing object and possibly handle visibility rules according to the context of the call. Note that even such relatively simple code transformations are error-prone: In the case of <code class="docutils literal notranslate"><span class="pre">return</span></code> transformations, it is most problematic that <code class="docutils literal notranslate"><span class="pre">return</span></code>s lead to abrupt completion of the surrounding method’s execution. Thus, we cannot simply replace a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement with an assignment. Furthermore, one has to correctly handle nested function definitions, and replace <code class="docutils literal notranslate"><span class="pre">return</span></code> statements with an assignment to the “right” variable.</p>
<p>To avoid these kinds of deep program transformations, we can <em>embed</em> the original function bodies into an artificial <em>wrapper statement providing the required context</em>, extending the symbolic interpreter to support such statements. <em>Method frames</em> <span id="id1">[<a class="reference internal" href="#id173"><span>ABB+16</span></a>]</span> as implemented in the KeY <a class="footnote-reference brackets" href="#key" id="id2">1</a> symbolic execution engine for the Java language realize this idea. In the context of minipy, a method frame statement has the following shape:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var</span><span class="p">):</span>
    <span class="n">body</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">body</span></code> is the function body and <code class="docutils literal notranslate"><span class="pre">var</span></code> is a variable name identifying the assignment target of returned expressions inside <code class="docutils literal notranslate"><span class="pre">body</span></code>.</p>
<div class="section" id="parsing-method-frames-and-transforming-function-calls">
<h2>Parsing Method Frames and Transforming Function Calls<a class="headerlink" href="#parsing-method-frames-and-transforming-function-calls" title="Permalink to this headline">¶</a></h2>
<p>We extend the minipy language to support method frames, that is, we add method frames to the grammar, add a new AST node class, and extend the <code class="docutils literal notranslate"><span class="pre">ASTConverter</span></code>. Finally, we re-declare the <code class="docutils literal notranslate"><span class="pre">parse</span></code> function to use the new <code class="docutils literal notranslate"><span class="pre">ASTConverter</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#% EXPORT</span>
<span class="n">MINIPY_GRAMMAR</span><span class="p">[</span><span class="s2">&quot;&lt;compound_stmt&gt;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&lt;method_frame&gt;&quot;</span><span class="p">)</span>
<span class="n">MINIPY_GRAMMAR</span><span class="p">[</span><span class="s2">&quot;&lt;method_frame&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;method-frame(result=&lt;NAME&gt;):&lt;block&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MethodFrame</span><span class="p">(</span><span class="n">ASTNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="s1">&#39;NameAtom&#39;</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Block</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;method-frame(result=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="si">{</span><span class="n">indent</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;    &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformer</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ASTNode</span><span class="p">],</span> <span class="n">ASTNode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ASTNode</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">transformer</span><span class="p">(</span><span class="n">MethodFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASTConverter</span><span class="p">(</span><span class="n">ASTConverter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt_interpretations</span><span class="p">[</span><span class="s2">&quot;&lt;method_frame&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_method_frame_stmt</span>
        
    <span class="k">def</span> <span class="nf">transform_method_frame_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">ParseTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MethodFrame</span><span class="p">:</span>
        <span class="n">m_res</span> <span class="o">=</span> <span class="n">match</span><span class="p">((</span><span class="s2">&quot;method-frame(result=&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;NAME&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;):&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;block&gt;&quot;</span><span class="p">),</span> <span class="n">stmt</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">m_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">MethodFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_atom</span><span class="p">(</span><span class="n">m_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_block</span><span class="p">(</span><span class="n">m_res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ASTNode&#39;</span><span class="p">:</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">strip_comments_and_whitespace</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">PythonPEGParser</span><span class="p">(</span><span class="n">MINIPY_GRAMMAR</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ASTConverter</span><span class="p">()</span><span class="o">.</span><span class="n">transform_top</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we should be able to parse a program containing a method frame statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">x = 17</span>

<span class="s2">method-frame(result=x):</span>
<span class="s2">    i = 42 + x</span>
<span class="s2">    return i</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display_program</span><span class="p">(</span><span class="n">mf_stmt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">17</span>

<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_program</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">mf_stmt</span><span class="p">)</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">x</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span>
</pre></div>
</div>
</div>
</div>
<p>The next step is to transform function calls in ASTs to method frames. We do so by writing three visitors/transformers, using the transformer infrastructure (method <code class="docutils literal notranslate"><span class="pre">transform</span></code>) of the <code class="docutils literal notranslate"><span class="pre">ASTNode</span></code> classes. Specifically, we implement</p>
<ol class="simple">
<li><p>A transformer (which is actually a “pure” visitor) <code class="docutils literal notranslate"><span class="pre">UsedVariablesVisitor</span></code> which collects variables used in a program,</p></li>
<li><p>a transformer <code class="docutils literal notranslate"><span class="pre">ReplaceFunctionCallsTransformer</span></code> collecting function calls in expressions, replacing them with fresh variables, and</p></li>
<li><p>the actual <code class="docutils literal notranslate"><span class="pre">MethodFrameTransformer</span></code> for replacing calls by method frames.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">UsedVariablesVisitor</span></code> is easy to implement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UsedVariablesVisitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASTNode</span><span class="p">)</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NameAtom</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_used_variables</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">UsedVariablesVisitor</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">search_program_ast</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">search_program</span><span class="p">)</span>
<span class="n">UsedVariablesVisitor</span><span class="o">.</span><span class="n">get_used_variables</span><span class="p">(</span><span class="n">search_program_ast</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;haystack&#39;, &#39;i&#39;, &#39;needle&#39;, &#39;r&#39;, &#39;t&#39;, &#39;x&#39;}
</pre></div>
</div>
</div>
</div>
<p>The class <code class="docutils literal notranslate"><span class="pre">ReplaceFunctionCallsTransformer</span></code> replaces each function call by a fresh variable and stores the mapping between introduced variables and replaced function calls to be retrieved for callers of the transformer. It requires a list of declared function names to make sure that no built-in functions or predicates are replaced.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ReplaceFunctionCallsTransformer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">used_variables</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">declared_functions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">used_variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fresh_var_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_functions</span> <span class="o">=</span> <span class="n">declared_functions</span>

    <span class="k">def</span> <span class="nf">fresh_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fresh_var_counter</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">while</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fresh_var_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fresh_var_counter</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">candidate</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASTNode</span><span class="p">)</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_functions</span><span class="p">:</span>
            <span class="n">fresh_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_variable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span><span class="p">[</span><span class="n">fresh_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">return</span> <span class="n">NameAtom</span><span class="p">(</span><span class="n">fresh_var</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>We declare a class <code class="docutils literal notranslate"><span class="pre">FilterASTVisitor</span></code>, which can be used, for example, to retrieve declared functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FilterASTVisitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ASTNode</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span> <span class="n">OrderedSet</span><span class="p">[</span><span class="n">ASTNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASTNode</span><span class="p">)</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span>    
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ASTNode</span><span class="p">],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedSet</span><span class="p">[</span><span class="n">ASTNode</span><span class="p">]:</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">FilterASTVisitor</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">program_with_many_calls</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">def f(a: int) -&gt; int:</span>
<span class="s2">    return a + 1</span>

<span class="s2">def g(b: int) -&gt; bool:</span>
<span class="s2">    return b &gt; 0</span>

<span class="s2">if f(x) + f(y) * 2 and Predicate(f(x)):</span>
<span class="s2">    assert g(13) and True </span>
<span class="s2">    return 17 + f(y + x)</span>
<span class="s2">else:</span>
<span class="s2">    assert g(z) and f(z) &gt; 3</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display_program</span><span class="p">(</span><span class="n">program_with_many_calls</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Predicate</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
    <span class="k">assert</span> <span class="n">g</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">True</span> 
    <span class="k">return</span> <span class="mi">17</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">g</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">program_with_many_calls_ast</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">program_with_many_calls</span><span class="p">)</span>
<span class="n">transformer</span> <span class="o">=</span> <span class="n">ReplaceFunctionCallsTransformer</span><span class="p">(</span>
    <span class="n">UsedVariablesVisitor</span><span class="o">.</span><span class="n">get_used_variables</span><span class="p">(</span><span class="n">program_with_many_calls_ast</span><span class="p">),</span>
    <span class="p">{</span><span class="n">function</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">FilterASTVisitor</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">program_with_many_calls_ast</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">))}</span>
<span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">program_with_many_calls_ast</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>

<span class="n">display_program</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="p">((</span><span class="n">var_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">var_1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="ow">and</span> <span class="n">Predicate</span><span class="p">(</span><span class="n">var_2</span><span class="p">)):</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">var_3</span> <span class="ow">and</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">17</span> <span class="o">+</span> <span class="n">var_4</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">var_5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var_6</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">variable</span><span class="p">:</span> <span class="n">call</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;var_0&#39;: &#39;f(x)&#39;,
 &#39;var_1&#39;: &#39;f(y)&#39;,
 &#39;var_2&#39;: &#39;f(x)&#39;,
 &#39;var_3&#39;: &#39;g(13)&#39;,
 &#39;var_4&#39;: &#39;f((y + x))&#39;,
 &#39;var_5&#39;: &#39;g(z)&#39;,
 &#39;var_6&#39;: &#39;f(z)&#39;}
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MethodFrameTransformer</span></code> stores information about all function <em>definitions</em> in the program being transformed, since the function bodies are needed for creating the method frames. Concretely, we maintain a mapping <code class="docutils literal notranslate"><span class="pre">self.functions:</span> <span class="pre">Dict[str,</span> <span class="pre">Callable[[List[Expression]],</span> <span class="pre">Block]]</span></code> from function names to functions taking a list of argument expressions to instantiate the formal parameters of the parsed function and returning its body. At the beginning of the returned body, we add a sequence of assignments setting the values of the formal parameters.</p>
<p>All statements whose AST classes immediately contain expressions are transformed to a sequence of method frames for all function calls occurring in the transformed statement, followed by the statement itself (with calls replaced by fresh variables used in method frames).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MethodFrameTransformer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span> <span class="o">=</span> <span class="n">UsedVariablesVisitor</span><span class="o">.</span><span class="n">get_used_variables</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Expression</span><span class="p">]],</span> <span class="n">Block</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ASTNode</span><span class="p">)</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ASTNode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_function_def</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
            <span class="n">expression</span><span class="p">,</span> <span class="n">method_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Stmts</span><span class="p">(</span><span class="n">method_frames</span> <span class="o">+</span> <span class="p">[</span><span class="n">Assignment</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">expression</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Assert</span><span class="p">):</span>
            <span class="n">expression</span><span class="p">,</span> <span class="n">method_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Stmts</span><span class="p">(</span><span class="n">method_frames</span> <span class="o">+</span> <span class="p">[</span><span class="n">Assert</span><span class="p">(</span><span class="n">expression</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ReturnStmt</span><span class="p">):</span>
            <span class="n">expression</span><span class="p">,</span> <span class="n">method_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Stmts</span><span class="p">(</span><span class="n">method_frames</span> <span class="o">+</span> <span class="p">[</span><span class="n">ReturnStmt</span><span class="p">(</span><span class="n">expression</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">IfStmt</span><span class="p">):</span>
            <span class="n">guard</span><span class="p">,</span> <span class="n">method_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">guard</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Stmts</span><span class="p">(</span><span class="n">method_frames</span> <span class="o">+</span> <span class="p">[</span><span class="n">IfStmt</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">then_block</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">else_block</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">process_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">:</span> <span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Expression</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ASTNode</span><span class="p">]]:</span>
        <span class="n">call_transformer</span> <span class="o">=</span> <span class="n">ReplaceFunctionCallsTransformer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="p">,</span>
            <span class="p">{</span><span class="n">function_name</span> <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">call_transformer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span> <span class="o">|=</span> <span class="n">call_transformer</span><span class="o">.</span><span class="n">used_variables</span>
        <span class="n">method_frames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">MethodFrame</span><span class="p">(</span><span class="n">NameAtom</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">f_call</span><span class="o">.</span><span class="n">name</span><span class="p">](</span><span class="n">f_call</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">f_call</span> <span class="ow">in</span> <span class="n">call_transformer</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">expression</span><span class="p">,</span> <span class="n">method_frames</span>

    <span class="k">def</span> <span class="nf">process_function_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">FunctionDef</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_block</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Expression</span><span class="p">]):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Assignment</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">stmts</span> <span class="o">+=</span> <span class="n">node</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">stmts</span>

            <span class="k">return</span> <span class="n">Block</span><span class="p">(</span><span class="n">stmts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_block</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformer</span> <span class="o">=</span> <span class="n">MethodFrameTransformer</span><span class="p">(</span><span class="n">program_with_many_calls_ast</span><span class="p">)</span>
<span class="n">display_program</span><span class="p">(</span><span class="n">program_with_many_calls_ast</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_4</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_5</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_6</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="p">((</span><span class="n">var_4</span> <span class="o">+</span> <span class="p">(</span><span class="n">var_5</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="ow">and</span> <span class="n">Predicate</span><span class="p">(</span><span class="n">var_6</span><span class="p">)):</span>
    <span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_0</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">var_0</span> <span class="ow">and</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">17</span> <span class="o">+</span> <span class="n">var_1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_2</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_3</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">var_2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var_3</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The astute reader might have noticed that we did not implement a transformation for calls in the guards of <code class="docutils literal notranslate"><span class="pre">while</span></code> statements. Since loop guards are evaluated repeatedly, replacing them requires the introduction of more than one method frame: One before the loop, one before every <code class="docutils literal notranslate"><span class="pre">continue</span></code> statement, and one after each code point in the loop body leading to a normal completion of the body. This kind of complex code transformation is exactly what we are trying to <em>avoid</em> by the introduction of method frames. In <a class="reference internal" href="static_loops.html#techniques-loops-static-se"><span class="std std-ref">Loops in Static Symbolic Execution</span></a>, we describe how to eliminate loops using loop invariants in the context of <em>static</em> symbolic execution. Ultimately, this results in the replacement of <code class="docutils literal notranslate"><span class="pre">while</span></code> by <code class="docutils literal notranslate"><span class="pre">if</span></code> statements, such that we can use the <code class="docutils literal notranslate"><span class="pre">MethodFrameTransformer</span></code> for the resulting programs without further modification.</p>
</div>
<div class="section" id="semantics-and-symbolic-execution-of-method-frames">
<h2>Semantics and Symbolic Execution of Method Frames<a class="headerlink" href="#semantics-and-symbolic-execution-of-method-frames" title="Permalink to this headline">¶</a></h2>
<p>Intuitively, the semantics of a method frame statement equals the semantics of its body, with the exception that a <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">expr</span></code> statement in the body leads to an assignment of <code class="docutils literal notranslate"><span class="pre">expr</span></code> to the <code class="docutils literal notranslate"><span class="pre">result</span></code> variable of the method frame. More precisely, in the style of the Java Language Specification <span id="id3">[<a class="reference internal" href="#id237"><span>GJSB05</span></a>]</span>:</p>
<p>A method frame statement with result variable <code class="docutils literal notranslate"><span class="pre">result</span></code> and body <code class="docutils literal notranslate"><span class="pre">body</span></code> is executed by executing <code class="docutils literal notranslate"><span class="pre">body</span></code>. Then there is a choice:</p>
<ol class="simple">
<li><p>If the execution of <code class="docutils literal notranslate"><span class="pre">body</span></code> completes abruptly because of a <code class="docutils literal notranslate"><span class="pre">return</span></code> of a value <code class="docutils literal notranslate"><span class="pre">value</span></code>, the method frame statement completes normally and <code class="docutils literal notranslate"><span class="pre">value</span></code> is assigned to <code class="docutils literal notranslate"><span class="pre">result</span></code>.</p></li>
<li><p>If the execution of <code class="docutils literal notranslate"><span class="pre">body</span></code> completes abruptly because of any other reason, the method frame statement completes abruptly for the same reason.</p></li>
</ol>
<p>Note that we did not define the case where <code class="docutils literal notranslate"><span class="pre">body</span></code> completes normally. The reason for this is that in <code class="docutils literal notranslate"><span class="pre">minipy</span></code>, we only have side effect-free functions which should always return a value if there is no other reason for their abrupt completion.</p>
<p>We can formalize the semantics of method frames even further by implementing it in the concrete minipy interpreter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interpreter</span><span class="p">(</span><span class="n">Interpreter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt_interpretations</span><span class="p">[</span><span class="n">MethodFrame</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_method_frame</span>
        
    <span class="k">def</span> <span class="nf">execute_method_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">MethodFrame</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">Environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_block</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">Return</span><span class="p">):</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">get_type</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="n">environment</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>
</pre></div>
</div>
</div>
</div>
<p>We can used this mechanized semantics to check whether our <code class="docutils literal notranslate"><span class="pre">MethodFrameTransformer</span></code> preserves the meaning of the transformed programs. Let us compare the execution results for the linear search program and its transformed version:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformer</span> <span class="o">=</span> <span class="n">MethodFrameTransformer</span><span class="p">(</span><span class="n">search_program_ast</span><span class="p">)</span>
<span class="n">search_program_transformed</span> <span class="o">=</span> <span class="n">search_program_ast</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>
<span class="n">display_program</span><span class="p">(</span><span class="n">search_program_transformed</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">needle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">haystack</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">haystack</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">haystack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">needle</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">)</span>
<span class="n">method</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">var_0</span><span class="p">):</span>
    <span class="n">needle</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">haystack</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">haystack</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">haystack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">needle</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">var_0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">INT_TYPE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpreter</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">()</span>
<span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
<span class="n">environment</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">interpreter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">search_program_ast</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
<span class="n">environment</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpreter</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">()</span>
<span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
<span class="n">environment</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">interpreter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">search_program_transformed</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
<span class="n">environment</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>After this promising result, we continue with the (straightforward) extension of the <em>symbolic</em> interpreter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicInterpreter</span><span class="p">(</span><span class="n">SymbolicInterpreter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">loop_unrolling_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">predicates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">z3</span><span class="o">.</span><span class="n">SortRef</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">z3</span><span class="o">.</span><span class="n">SortRef</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">loop_unrolling_threshold</span><span class="p">,</span> <span class="n">predicates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt_interpretations</span><span class="p">[</span><span class="n">MethodFrame</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_method_frame</span>
        
    <span class="k">def</span> <span class="nf">execute_method_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">MethodFrame</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">SymbolicEnvironment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SET</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_block</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">SETNode</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">code</span><span class="p">),</span> <span class="p">[</span><span class="n">tree</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">get_leaves</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">leaf</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">abrupt_completion</span>

            <span class="k">assert</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">SymbolicReturn</span><span class="p">):</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">get_type_for_z3_expr</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">replace_in_tree</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="p">(</span><span class="n">SETNode</span><span class="p">(</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">set_abrupt_completion</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="p">[]))</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>Now, symbolically executing the linear search program (with method frames) yields an SET which is <em>transparent</em> in the sense that all executed statements actually occur:</p>
<div class="cell tag_output_scroll tag_full-width docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span> <span class="o">=</span> <span class="n">SymbolicEnvironment</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">to_z3</span><span class="p">())</span>
<span class="n">predicates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">z3</span><span class="o">.</span><span class="n">SeqSort</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">IntSort</span><span class="p">()),),</span> <span class="n">z3</span><span class="o">.</span><span class="n">IntSort</span><span class="p">(),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Length</span><span class="p">)}</span>
<span class="n">interpreter</span> <span class="o">=</span> <span class="n">SymbolicInterpreter</span><span class="p">(</span><span class="n">predicates</span><span class="o">=</span><span class="n">predicates</span><span class="p">)</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">search_program_transformed</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
<span class="n">display_set</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/transparent_function_execution_40_0.svg" src="_images/transparent_function_execution_40_0.svg" /></div>
</div>
<p>In the next section, we discuss how to handle unbounded loops in static, exhaustive symbolic execution. In the course of this, we also introduce so-called <em>loop scopes</em>, another kind of artificial statement related to method frames with the purpose of enabling sound static symbolic execution of loops with minimal program transformation.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p id="id4"><dl class="citation">
<dt class="label" id="id173"><span class="brackets"><a class="fn-backref" href="#id1">ABB+16</a></span></dt>
<dd><p>Wolfgang Ahrendt, Bernhard Beckert, Richard Bubel, Reiner Hähnle, Peter H. Schmitt, and Mattias Ulbrich, editors. <em>Deductive Software Verification – The KeY Book</em>. Volume 10001 of LNCS. Springer, 2016. <a class="reference external" href="https://doi.org/10.1007/978-3-319-49812-6">doi:10.1007/978-3-319-49812-6</a>.</p>
</dd>
<dt class="label" id="id237"><span class="brackets"><a class="fn-backref" href="#id3">GJSB05</a></span></dt>
<dd><p>James Gosling, Bill Joy, Guy Steele, and Gilad Bracha. <em>The Java (TM) Language Specification</em>. Addison-Wesley Professional, 3rd edition, 2005. ISBN 0321246780.</p>
</dd>
</dl>
</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="key"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p><a class="reference external" href="https://www.key-project.org">https://www.key-project.org</a></p>
</dd>
</dl>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="techniques.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Techniques</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="static_loops.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Loops in Static Symbolic Execution</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Dominic Steinhöfel<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>